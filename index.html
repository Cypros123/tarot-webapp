<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Выбор карт — 3 из 7</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg1:#0e0b0d; --bg2:#24161a;
      --gold:#d9b36c; --accent:#e9c891; --ink:#f5f1e8; --muted:#bda78b;
      --card:#241215; --card-edge:#6d3b3f; --glow: 0 0 24px rgba(233,200,145,.55);
      --cardW: 116px; --ratio: 1.6; /* 5:8 */
      --gap: 14px;
      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans",sans-serif;
      color:var(--ink);
      background:
        radial-gradient(120% 100% at 50% -10%, rgba(233,200,145,.08), transparent 60%),
        radial-gradient(140% 120% at 50% 0%, var(--bg2), var(--bg1) 60%);
      display:flex; flex-direction:column; min-height:100%;
    }
    header{
      position:sticky; top:0; z-index:5;
      padding:calc(10px + var(--safeTop)) 16px 10px;
      background:linear-gradient(180deg, rgba(0,0,0,.6), rgba(0,0,0,0));
      border-bottom:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(4px);
    }
    .title{font-weight:700; font-size:16px; letter-spacing:.2px}
    .subtitle{font-size:12px; color:var(--muted)}

    .wrap{padding:12px 14px calc(12px + var(--safeBottom)); max-width:960px; width:100%; margin:0 auto;}
    .rows{display:flex; flex-direction:column; gap:16px; align-items:center; justify-content:center;}
    .row{ display:flex; gap:var(--gap); justify-content:center; align-items:flex-start; width:100%; flex-wrap:nowrap; }
    .row.r1{ /* верхние 3 карты */ }
    .row.r2{ /* нижние 4 карты */ }

    .card{
      width:var(--cardW);
      height:calc(var(--cardW) * var(--ratio));
      border-radius:14px;
      position:relative; cursor:pointer; perspective:1000px;
      flex:0 0 auto;
    }
    .card-inner{
      position:absolute; inset:0; transform-style:preserve-3d;
      transition: transform 1s ease-in-out, box-shadow .35s ease; /* flip = 1.0s */
      border-radius:14px; overflow:hidden;
      box-shadow:0 10px 22px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.04);
      will-change: transform;
    }
    .card:hover .card-inner{ transform: translateY(-1px); }
    .card.selected .card-inner{ transform: rotateY(180deg); box-shadow: var(--glow), 0 10px 22px rgba(0,0,0,.55); }
    .card.locked{ pointer-events:none; }

    .face,.back{ position:absolute; inset:0; backface-visibility:hidden; border-radius:14px; }
    .back{
      background:
        radial-gradient(60% 40% at 30% 20%, rgba(233,200,145,.07), transparent 36%),
        radial-gradient(50% 40% at 70% 80%, rgba(233,200,145,.05), transparent 40%),
        linear-gradient(145deg, var(--card), #1a0f12);
      border:1px solid var(--card-edge);
      display:flex; align-items:center; justify-content:center;
    }
    .sigil{ width:62%; height:62%; border-radius:50%; border:2px dashed rgba(217,179,108,.55);
      display:grid; place-items:center; filter: drop-shadow(0 2px 4px rgba(0,0,0,.35)); position:relative; }
    .sigil::after{ content:""; position:absolute; inset:12%; border-radius:50%; border:1px solid rgba(217,179,108,.35); }
    .sigil svg{ width:70%; opacity:.9; }

    .face{ transform: rotateY(180deg);
      background:
        radial-gradient(140% 120% at 50% -10%, rgba(250,220,150,.10), transparent 60%),
        linear-gradient(160deg, #2b181b, #1b1013 70%);
      border:1px solid rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      position:relative; overflow:hidden;
    }
    .art{ width:84%; height:88%; border-radius:12px; overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05), 0 2px 6px rgba(0,0,0,.35);
      background:#000; display:flex; align-items:center; justify-content:center;
    }
    .art img{ width:100%; height:100%; object-fit:cover; display:block; }

    .finalbar{
      position:fixed; left:0; right:0; bottom:0; z-index:7;
      padding:16px calc(16px + var(--safeBottom));
      display:none; gap:12px; align-items:center; justify-content:center; flex-direction:column;
      background:linear-gradient(0deg, rgba(0,0,0,.72), rgba(0,0,0,.0));
    }
    .finalbar.show{ display:flex; }
    .final-row{ display:flex; gap:12px; }
    .mini{
      width:calc(var(--cardW) * .8); aspect-ratio:5/8; border-radius:12px; overflow:hidden; box-shadow: var(--glow), 0 8px 16px rgba(0,0,0,.5);
      border:1px solid rgba(255,255,255,.08);
      background:#000;
    }
    .mini img{ width:100%; height:100%; object-fit:cover; display:block; }
    .btn{
      padding:12px 18px; border-radius:14px; border:1px solid rgba(255,255,255,.14); font-weight:700;
      background:linear-gradient(180deg, rgba(233,200,145,.22), rgba(233,200,145,.10)); color:var(--ink); cursor:pointer;
    }

    .fly-layer{ position:fixed; inset:0; pointer-events:none; z-index:9; }
    .fly-card{ position:absolute; width:var(--cardW); height:calc(var(--cardW)*var(--ratio)); border-radius:14px; will-change: transform; transition: transform 1.5s ease-in-out; }
    .fade-out{ opacity:0; transition: opacity .35s ease; }
    body.centered .rows{ opacity:0; pointer-events:none; transition: opacity .35s ease; }
  </style>
</head>
<body>
  <header>
    <div class="title">Выберите 3 карты</div>
    <div class="subtitle">Коснитесь карты — она перевернётся и выбор закрепится</div>
  </header>

  <div class="wrap">
    <div class="rows" id="rows">
      <div class="row r1" id="r1"></div>
      <div class="row r2" id="r2"></div>
    </div>
  </div>

  <div class="finalbar" id="finalbar">
    <div class="final-row" id="finalRow"></div>
    <button class="btn" id="confirm">Продолжить</button>
  </div>

  <div class="fly-layer" id="fly"></div>

  <script>
    const tg = window.Telegram?.WebApp; if (tg){tg.ready(); tg.expand();}
    const LIMIT = 3;
    const ids = [3,14,27, 45,9,62,71]; // 3+4

    const r1 = document.getElementById('r1');
    const r2 = document.getElementById('r2');
    const finalbar = document.getElementById('finalbar');
    const finalRow = document.getElementById('finalRow');
    const fly = document.getElementById('fly');
    const btn = document.getElementById('confirm');

    let selected = [];

    function faceUrl(id){ return `faces/${id%22}.png`; }

    function makeCard(id){
      const card = document.createElement('button');
      card.className = 'card';
      card.type = 'button';
      card.dataset.id = String(id);

      const inner = document.createElement('div');
      inner.className = 'card-inner';

      const back = document.createElement('div');
      back.className = 'back';
      back.innerHTML = `
        <div class='sigil' aria-hidden='true'>
          <svg viewBox='0 0 100 100' fill='none' xmlns='http://www.w3.org/2000/svg'>
            <circle cx='50' cy='50' r='30' stroke='${getComputedStyle(document.documentElement).getPropertyValue('--gold').trim()}' stroke-width='3' />
            <path d='M50 22 L54 46 L78 50 L54 54 L50 78 L46 54 L22 50 L46 46 З' stroke='${getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()}' stroke-width='2'/>
          </svg>
        </div>`;

      const face = document.createElement('div');
      face.className = 'face';
      const art = document.createElement('div');
      art.className = 'art';
      const img = document.createElement('img'); img.src = faceUrl(id); img.alt = 'card';
      art.appendChild(img); face.appendChild(art);

      inner.appendChild(back); inner.appendChild(face);
      card.appendChild(inner);

      card.addEventListener('click', () => select(card, id));
      return card;
    }

    function computeCardWidth(){
      const vw = Math.min(window.innerWidth, document.documentElement.clientWidth);
      const vh = Math.min(window.innerHeight, document.documentElement.clientHeight);
      const gap = 14; // px
      // ограничение по ширине: 3 карты наверху, 4 внизу
      const maxWByRowTop = (vw - gap*2 - 28) / 3;   // 3 карты + поля
      const maxWByRowBot = (vw - gap*3 - 28) / 4;   // 4 карты + поля
      const maxWByWidth = Math.min(maxWByRowTop, maxWByRowBot);

      // ограничение по высоте: две строки + зазор
      const headerH = 72; // примерно
      const bottomPad = 24;
      const availableH = vh - headerH - bottomPad - 20; // запас
      const maxWByHeight = (availableH - 16) / (2 * 1.6); // 2 ряда, aspect 1.6

      // комфортный предел на больших экранах
      const comfort = 140;

      const cardW = Math.max(90, Math.min(comfort, maxWByWidth, maxWByHeight));
      document.documentElement.style.setProperty('--cardW', cardW + 'px');
    }

    function build(){
      computeCardWidth();
      for (let i=0;i<3;i++) r1.appendChild(makeCard(ids[i]));
      for (let i=3;i<7;i++) r2.appendChild(makeCard(ids[i]));
      window.addEventListener('resize', computeCardWidth, {passive:true});
      window.addEventListener('orientationchange', ()=>setTimeout(computeCardWidth, 100));
    }

    function select(card, id){
      if (selected.length >= LIMIT) return;
      if (card.classList.contains('locked')) return;
      card.classList.add('selected','locked');
      selected.push(id);
      updateFinalBar();
      if (selected.length === LIMIT) {
        moveToCenter();
      }
    }

    function updateFinalBar(){
      finalRow.innerHTML='';
      selected.forEach(id => {
        const box=document.createElement('div');
        box.className='mini';
        const img=document.createElement('img'); img.src=faceUrl(id);
        box.appendChild(img);
        finalRow.appendChild(box);
      });
      finalbar.classList.add('show');
    }

    function moveToCenter(){
      fly.innerHTML='';

      // плавно скрываем невыбранные
      document.querySelectorAll('.card').forEach(el=>{
        const id = Number(el.dataset.id);
        if (!selected.includes(id)){
          el.classList.add('fade-out');
          el.style.pointerEvents = 'none';
        }
      });

      // собираем геометрию выбранных
      const chosen = [];
      document.querySelectorAll('.card').forEach(el=>{
        const id = Number(el.dataset.id);
        if (selected.includes(id)){
          chosen.push({ id, rect: el.getBoundingClientRect() });
        }
      });

      // создаём клоны в исходных координатах (left/top = место старта)
      const clones = chosen.map(({id, rect})=>{
        const c = document.createElement('div');
        c.className = 'fly-card';
        c.style.left = rect.left + 'px';
        c.style.top  = rect.top  + 'px';
        c.style.transform = 'translate(0,0) scale(1,1)'; // старт без сдвига
        c.innerHTML = `
          <div class=\"card-inner\" style=\"transform:rotateY(180deg);\">
            <div class=\"face\">
              <div class=\"art\"><img src=\"${faceUrl(id)}\" alt=\"card\"></div>
            </div>
          </div>`;
        fly.appendChild(c);
        return {el:c, rect};
      });

      // целевая компоновка по центру (анимируем ТОЛЬКО transform)
      const gap = 16;
      const cardW = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cardW'));
      const targetW = Math.min(150, Math.max(100, cardW + 6)); // чуть крупнее
      const targetH = targetW * 1.6;
      const totalW  = targetW*3 + gap*2;
      const startX  = (window.innerWidth - totalW)/2;
      const y       = (window.innerHeight - targetH)/2 + 20;

      clones.forEach(({el, rect}, i)=>{
        const tx = startX + i*(targetW+gap);
        const ty = y;
        const dx = tx - rect.left;
        const dy = ty - rect.top;
        const sx = targetW / rect.width;
        const sy = targetH / rect.height;

        el.style.transition = 'transform 1.5s ease-in-out';
        el.style.transitionDelay = (i * 150) + 'ms';

        requestAnimationFrame(()=>{
          requestAnimationFrame(()=>{
            el.style.transform = `translate(${dx}px, ${dy}px) scale(${sx}, ${sy})`;
          });
        });
      });

      document.body.classList.add('centered');
      setTimeout(()=>{ finalbar.style.display='none'; }, 800);
    }

    btn.addEventListener('click', () => {
      const payload={ type:'tarot_selection', cards:selected };
      if (tg){ tg.sendData(JSON.stringify(payload)); tg.close(); }
      else { alert(JSON.stringify(payload)); }
    });

    build();
  </script>
</body>
</html>

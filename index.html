<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tarot WebApp</title>
  <style>
    :root{
      --card-w: 96px;
      --card-h: 152px;
      --gap: 12px;
      --flip-ms: 420ms;
      --move-ms: 800ms;
      --ease: cubic-bezier(.2,.7,.2,1);
    }
    *{box-sizing:border-box}
    html,body{
      margin:0; padding:0; height:100%;
      background: #0b0b0f;
      color:#eae6ff; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{
      min-height:100dvh; display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding: clamp(8px, 3vw, 24px);
      gap: 18px;
    }
    .stage{
      position:relative;
      width: calc( (var(--card-w) * 4) + (var(--gap) * 3) );
      height: calc( (var(--card-h) * 2) + (var(--gap) * 1) );
      transform: translateZ(0);
    }
    @media (max-width: 420px){
      .stage{ transform: scale(.9); transform-origin: top center; }
    }
    @media (max-width: 360px){
      .stage{ transform: scale(.82); }
    }

    .card{
      position:absolute;
      width:var(--card-w); height:var(--card-h);
      border-radius:12px; overflow:hidden;
      transform-style:preserve-3d;
      transition: transform var(--flip-ms) ease;
      cursor:pointer;
      box-shadow: 0 12px 24px rgba(0,0,0,.55);
      will-change: transform;
    }
    .card .face{
      position:absolute; inset:0;
      backface-visibility:hidden;
    }
    .card .back{
      background: url('faces/back.png?v=12') center/cover no-repeat;
    }
    .card .front{
      transform: rotateY(180deg);
    }
    .card .front img{
      display:block; width:100%; height:100%; object-fit:cover;
    }
    .flipped{ transform: rotateY(180deg) translateZ(0); }

    /* movement layer: we'll animate translate without changing initial left/top */
    .move{
      transition: transform var(--move-ms) var(--ease);
      will-change: transform;
    }

    .hint{opacity:.85; font-size:14px; text-align:center;}
    .cta{display:none; width:100%; max-width:420px; justify-content:center;}
    .cta button{
      appearance:none; border:0; border-radius:12px;
      padding:14px 16px; width:100%;
      background:#f0cd72; color:#241a07; font-weight:700; font-size:16px;
      box-shadow: 0 6px 14px rgba(240,205,114,.35);
    }
    .cta.show{display:flex;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stage" id="stage"></div>
    <div class="hint" id="hint">Выберите 3 карты</div>
    <div class="cta" id="cta"><button id="go">Продолжить</button></div>
  </div>

  <script>
    const STAGE = document.getElementById('stage');
    const HINT = document.getElementById('hint');
    const CTA  = document.getElementById('cta');
    const GO   = document.getElementById('go');

    const CW=96, CH=152, GAP=12, NEED=3, COUNT=7;
    const faces = Array.from({length:22}, (_,i)=>`faces/${i}.png?v=12`);

    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a}
    const picked = shuffle([...faces]).slice(0, COUNT);

    // initial positions (left/top only once)
    function xy(i){
      const row = i < 3 ? 0 : 1;
      const col = row === 0 ? i : (i-3);
      return [col*(CW+GAP), row*(CH+GAP)];
    }

    const cards = [];
    for (let i=0;i<COUNT;i++){
      const [l,t] = xy(i);
      const el = document.createElement('div');
      el.className = 'card move';
      el.style.left = l + 'px';
      el.style.top  = t + 'px';

      const back = document.createElement('div'); back.className = 'face back';
      const front = document.createElement('div'); front.className = 'face front';
      const img = document.createElement('img'); img.src = picked[i];
      front.appendChild(img);

      el.appendChild(back); el.appendChild(front);
      STAGE.appendChild(el);
      cards.push({el, flipped:false, dx:0, dy:0});
    }

    let opened=0, last=null;
    function onClick(card){
      if(card.flipped || opened>=NEED) return;
      card.flipped = true;
      card.el.classList.add('flipped');
      opened++; last=card;
      HINT.textContent = opened<NEED ? `Осталось выбрать: ${NEED-opened}` : 'Готово';

      if(opened===NEED){
        const onEnd=(e)=>{
          if(e.propertyName!=='transform') return;
          card.el.removeEventListener('transitionend', onEnd);
          moveToCenter();
        };
        card.el.addEventListener('transitionend', onEnd);
      }
    }
    cards.forEach(c=> c.el.addEventListener('click', ()=>onClick(c)) );

    function moveToCenter(){
      const chosen = cards.filter(c=>c.flipped);
      // Compute target X offsets (center 3 cards in 4-col width)
      const totalW = 4*CW + 3*GAP;
      const rowW = 3*CW + 2*GAP;
      const left0 = (totalW - rowW)/2;
      const topRow = CH + GAP; // visually middle

      chosen.forEach((c,k)=>{
        // current left/top from style, compute dx/dy to target
        const curLeft = parseInt(c.el.style.left||0,10);
        const curTop  = parseInt(c.el.style.top||0,10);
        const targetLeft = Math.round(left0 + k*(CW+GAP));
        const targetTop  = Math.round(topRow);
        const dx = targetLeft - curLeft;
        const dy = targetTop  - curTop;
        c.dx = dx; c.dy = dy;
        c.el.style.transform = `rotateY(180deg) translate(${dx}px, ${dy}px)`;
      });

      CTA.classList.add('show');
    }

    GO.addEventListener('click', ()=>{
      try{
        if (window.Telegram && Telegram.WebApp){
          Telegram.WebApp.sendData(JSON.stringify({type:"selection_done", count:NEED}));
          Telegram.WebApp.close();
          return;
        }
      }catch(e){}
      alert('Выбор сохранён. Возвращаемся в бота…');
    });
  </script>
</body>
</html>
